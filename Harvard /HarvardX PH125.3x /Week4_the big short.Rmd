---
title: "4.1 The Big Short"
output: html_notebook
---

Correction
At 2:35, the displayed results of the code are incorrect. Here are the correct values:

n*(p*loss_per_foreclosure + (1-p)*0)
[1] -4e+06
sqrt(n)*abs(loss_per_foreclosure)*sqrt(p*(1-p))
[1] 885438
Key points
Interest rates for loans are set using the probability of loan defaults to calculate a rate that minimizes the probability of losing money.
We can define the outcome of loans as a random variable. We can also define the sum of outcomes of many loans as a random variable.
The Central Limit Theorem can be applied to fit a normal distribution to the sum of profits over many loans. We can use properties of the normal distribution to calculate the interest rate needed to ensure a certain probability of losing money for a given probability of default.

Code: Interest rate sampling model

```{r}
n <- 1000
loss_per_foreclosure <- -200000
p <- 0.02
defaults <- sample( c(0,1), n, prob=c(1-p, p), replace = TRUE)
sum(defaults * loss_per_foreclosure)
```

Code: Interest rate Monte Carlo simulation

```{r}
B <- 10000
losses <- replicate(B, {
    defaults <- sample( c(0,1), n, prob=c(1-p, p), replace = TRUE) 
  sum(defaults * loss_per_foreclosure)
})
```

Code: Plotting expected losses


```{r}
library(tidyverse)
data.frame(losses_in_millions = losses/10^6) %>%
    ggplot(aes(losses_in_millions)) +
    geom_histogram(binwidth = 0.6, col = "black")
```

Code: Expected value and standard error of the sum of 1,000 loans
```{r}
n*(p*loss_per_foreclosure + (1-p)*0)    # expected value 
sqrt(n)*abs(loss_per_foreclosure)*sqrt(p*(1-p))    # standard error
```
Code: Calculating interest rates for expected value of 0
We can calculate the amount ğ‘¥ to add to each loan so that the expected value is 0 using the equation ğ‘™ğ‘+ğ‘¥(1âˆ’ğ‘)=0. Note that this equation is the definition of expected value given a loss per foreclosure ğ‘™ with foreclosure probability ğ‘ and profit ğ‘¥ if there is no foreclosure (probability 1âˆ’ğ‘).

We solve for ğ‘¥=âˆ’ğ‘™ğ‘1âˆ’ğ‘ and calculate ğ‘¥:

```{r}
x = - loss_per_foreclosure*p/(1-p)
x
```

On a $180,000 loan, this equals an interest rate of:

```{r}
x/180000

```

Equations: Calculating interest rate for 1% probability of losing money
We want to calculate the value of ğ‘¥ for which Pr(ğ‘†<0)=0.01. The expected value E[ğ‘†] of the sum of ğ‘›=1000 loans given our definitions of ğ‘¥, ğ‘™ and ğ‘ is:

ğœ‡ğ‘†=(ğ‘™ğ‘+ğ‘¥(1âˆ’ğ‘))âˆ—ğ‘›
And the standard error of the sum of ğ‘› loans, SE[ğ‘†], is:

ğœğ‘†=âˆ£ğ‘¥âˆ’ğ‘™âˆ£ğ‘›ğ‘(1âˆ’ğ‘)â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆš
Because we know the definition of a Z-score is ğ‘=ğ‘¥âˆ’ğœ‡ğœ, we know that Pr(ğ‘†<0)=Pr(ğ‘<âˆ’ğœ‡ğœ). Thus, Pr(ğ‘†<0)=0.01 equals:

Pr(ğ‘<âˆ’{ğ‘™ğ‘+ğ‘¥(1âˆ’ğ‘)}ğ‘›(ğ‘¥âˆ’ğ‘™)ğ‘›ğ‘(1âˆ’ğ‘)â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆš)=0.01
z<-qnorm(0.01) gives us the value of ğ‘§ for which Pr(ğ‘â‰¤ğ‘§)=0.01, meaning:

ğ‘§=âˆ’{ğ‘™ğ‘+ğ‘¥(1âˆ’ğ‘)}ğ‘›(ğ‘¥âˆ’ğ‘™)ğ‘›ğ‘(1âˆ’ğ‘)â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆš
Solving for ğ‘¥ gives:

ğ‘¥=âˆ’ğ‘™ğ‘›ğ‘âˆ’ğ‘§ğ‘›ğ‘(1âˆ’ğ‘)â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆšğ‘›(1âˆ’ğ‘)+ğ‘§ğ‘›ğ‘(1âˆ’ğ‘)â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆš
Code: Calculating interest rate for 1% probability of losing money

```{r}
l <- loss_per_foreclosure
z <- qnorm(0.01)
x <- -l*( n*p - z*sqrt(n*p*(1-p)))/ ( n*(1-p) + z*sqrt(n*p*(1-p)))\x
x/180000    # interest rate
loss_per_foreclosure*p + x*(1-p)    # expected value of the profit per loan
n*(loss_per_foreclosure*p + x*(1-p)) # expected value of the profit over n loans
```
Code: Monte Carlo simulation for 1% probability of losing money
Note that your results will vary from the video because the seed is not set.

```{r}
B <- 100000
profit <- replicate(B, {
    draws <- sample( c(x, loss_per_foreclosure), n, 
                        prob=c(1-p, p), replace = TRUE) 
    sum(draws)
})
mean(profit)    # expected value of the profit over n loans
mean(profit<0)    # probability of losing money
```


Code: Expected value with higher default rate and interest rate

```{r}
p <- .04
loss_per_foreclosure <- -200000
r <- 0.05
x <- r*180000
loss_per_foreclosure*p + x*(1-p)
```

Equations: Probability of losing money
We can define our desired probability of losing money, ğ‘§, as:

Pr(ğ‘†<0)=Pr(ğ‘<âˆ’E[ğ‘†]SE[ğ‘†])=ğ‘ƒğ‘Ÿ(ğ‘<ğ‘§)
If ğœ‡ is the expected value of the urn (one loan) and ğœ is the standard deviation of the urn (one loan), then E[ğ‘†]=ğ‘›ğœ‡ and SE[ğ‘†]=ğ‘›âˆšğœ.

As in the previous video, we define the probability of losing money ğ‘§=0.01. In the first equation, we can see that:

ğ‘§=âˆ’E[ğ‘†]SE[ğ‘†]
It follows that:

ğ‘§=âˆ’ğ‘›ğœ‡ğ‘›âˆšğœ=âˆ’ğ‘›âˆšğœ‡ğœ
To find the value of ğ‘› for which ğ‘§ is less than or equal to our desired value, we take ğ‘§â‰¤âˆ’ğ‘›âˆšğœ‡ğœ and solve for ğ‘›:

ğ‘›â‰¥ğ‘§2ğœ2ğœ‡2
Code: Calculating number of loans for desired probability of losing money


```{r}
z <- qnorm(0.01)
l <- loss_per_foreclosure
n <- ceiling((z^2*(x-l)^2*p*(1-p))/(l*p + x*(1-p))^2)
n    # number of loans required
n*(loss_per_foreclosure*p + x * (1-p))    # expected profit over n loans
```
Code: Monte Carlo simulation with known default probability
This Monte Carlo simulation estimates the expected profit given a known probability of default ğ‘=0.04. Note that your results will differ from the video because the seed is not set.

```{r}
B <- 10000
p <- 0.04
x <- 0.05 * 180000
profit <- replicate(B, {
    draws <- sample( c(x, loss_per_foreclosure), n, 
                        prob=c(1-p, p), replace = TRUE) 
    sum(draws)
})
mean(profit)
```
Code: Monte Carlo simulation with unknown default probability
This Monte Carlo simulation estimates the expected profit given an unknown probability of default 0.03â‰¤ğ‘â‰¤0.05, modeling the situation where an event changes the probability of default for all borrowers simultaneously. Note that your results will differ from the video because the seed is not set.

```{r}
p <- 0.04
x <- 0.05*180000
profit <- replicate(B, {
    new_p <- 0.04 + sample(seq(-0.01, 0.01, length = 100), 1)
    draws <- sample( c(x, loss_per_foreclosure), n, 
                        prob=c(1-new_p, new_p), replace = TRUE)
    sum(draws)
})
mean(profit)    # expected profit
mean(profit < 0)    # probability of losing money
mean(profit < -10000000)    # probability of losing over $10 million
```

